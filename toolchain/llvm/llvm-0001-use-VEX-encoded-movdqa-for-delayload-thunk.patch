From 82882b3c07f14f511532c4e5827e40012817403f Mon Sep 17 00:00:00 2001
From: _ <>
Date: Fri, 2 Jan 2026 00:00:00 +0000
Subject: [PATCH] use VEX-encoded movdqa for delayload thunk

---
 lld/COFF/DLL.cpp | 16 ++++++++--------
 1 file changed, 8 insertions(+), 8 deletions(-)

diff --git a/lld/COFF/DLL.cpp b/lld/COFF/DLL.cpp
index 10bc89824..6a54b712f 100644
--- a/lld/COFF/DLL.cpp
+++ b/lld/COFF/DLL.cpp
@@ -249,17 +249,17 @@ static const uint8_t tailMergeX64[] = {
     0x4C, 0x89, 0x44, 0x24, 0x18,          // mov    qword ptr [rsp+18h], r8
     0x4C, 0x89, 0x4C, 0x24, 0x20,          // mov    qword ptr [rsp+20h], r9
     0x48, 0x83, 0xEC, 0x68,                // sub    rsp, 68h
-    0x66, 0x0F, 0x7F, 0x44, 0x24, 0x20,    // movdqa xmmword ptr [rsp+20h], xmm0
-    0x66, 0x0F, 0x7F, 0x4C, 0x24, 0x30,    // movdqa xmmword ptr [rsp+30h], xmm1
-    0x66, 0x0F, 0x7F, 0x54, 0x24, 0x40,    // movdqa xmmword ptr [rsp+40h], xmm2
-    0x66, 0x0F, 0x7F, 0x5C, 0x24, 0x50,    // movdqa xmmword ptr [rsp+50h], xmm3
+    0xC5, 0xF9, 0x7F, 0x44, 0x24, 0x20,    // vmovdqa xmmword ptr [rsp+20h], xmm0
+    0xC5, 0xF9, 0x7F, 0x4C, 0x24, 0x30,    // vmovdqa xmmword ptr [rsp+30h], xmm1
+    0xC5, 0xF9, 0x7F, 0x54, 0x24, 0x40,    // vmovdqa xmmword ptr [rsp+40h], xmm2
+    0xC5, 0xF9, 0x7F, 0x5C, 0x24, 0x50,    // vmovdqa xmmword ptr [rsp+50h], xmm3
     0x48, 0x8B, 0xD0,                      // mov    rdx, rax
     0x48, 0x8D, 0x0D, 0, 0, 0, 0,          // lea    rcx, [___DELAY_IMPORT_...]
     0xE8, 0, 0, 0, 0,                      // call   __delayLoadHelper2
-    0x66, 0x0F, 0x6F, 0x44, 0x24, 0x20,    // movdqa xmm0, xmmword ptr [rsp+20h]
-    0x66, 0x0F, 0x6F, 0x4C, 0x24, 0x30,    // movdqa xmm1, xmmword ptr [rsp+30h]
-    0x66, 0x0F, 0x6F, 0x54, 0x24, 0x40,    // movdqa xmm2, xmmword ptr [rsp+40h]
-    0x66, 0x0F, 0x6F, 0x5C, 0x24, 0x50,    // movdqa xmm3, xmmword ptr [rsp+50h]
+    0xC5, 0xF9, 0x6F, 0x44, 0x24, 0x20,    // vmovdqa xmm0, xmmword ptr [rsp+20h]
+    0xC5, 0xF9, 0x6F, 0x4C, 0x24, 0x30,    // vmovdqa xmm1, xmmword ptr [rsp+30h]
+    0xC5, 0xF9, 0x6F, 0x54, 0x24, 0x40,    // vmovdqa xmm2, xmmword ptr [rsp+40h]
+    0xC5, 0xF9, 0x6F, 0x5C, 0x24, 0x50,    // vmovdqa xmm3, xmmword ptr [rsp+50h]
     0x48, 0x8B, 0x4C, 0x24, 0x70,          // mov    rcx, qword ptr [rsp+70h]
     0x48, 0x8B, 0x54, 0x24, 0x78,          // mov    rdx, qword ptr [rsp+78h]
     0x4C, 0x8B, 0x84, 0x24, 0x80, 0, 0, 0, // mov    r8, qword ptr [rsp+80h]
-- 
2.52.0

